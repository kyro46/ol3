// Custom Context Menu for Openlayers 3.
// https://github.com/jonataswalker/ol3-contextmenu
// Version: v1.2.0
// Built: 2016-03-31T22:38:31-0300

"use strict";!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):e.ContextMenu=t()}(this,function(){var e={},t={whiteSpaceRegex:/\s+/,to3857:function(e){return ol.proj.transform([parseFloat(e[0]),parseFloat(e[1])],"EPSG:4326","EPSG:3857")},to4326:function(e){return ol.proj.transform([parseFloat(e[0]),parseFloat(e[1])],"EPSG:3857","EPSG:4326")},isNumeric:function(e){return/^\d+$/.test(e)},classRegex:function(e){return new RegExp("(^|\\s+)"+e+"(\\s+|$)")},addClass:function(e,n,a){if(Array.isArray(e))return void e.forEach(function(e){t.addClass(e,n)});for(var s=Array.isArray(n)?n:n.split(/\s+/),r=s.length;r--;)t.hasClass(e,s[r])||t._addClass(e,s[r],a)},_addClass:function(e,n,a){e.classList?e.classList.add(n):e.className=(e.className+" "+n).trim(),a&&t.isNumeric(a)&&window.setTimeout(function(){t._removeClass(e,n)},a)},removeClass:function(e,n,a){if(Array.isArray(e))return void e.forEach(function(e){t.removeClass(e,n,a)});for(var s=Array.isArray(n)?n:n.split(/\s+/),r=s.length;r--;)t.hasClass(e,s[r])&&t._removeClass(e,s[r],a)},_removeClass:function(e,n,a){e.classList?e.classList.remove(n):e.className=e.className.replace(t.classRegex(n)," ").trim(),a&&t.isNumeric(a)&&window.setTimeout(function(){t._addClass(e,n)},a)},hasClass:function(e,n){return e.classList?e.classList.contains(n):t.classRegex(n).test(e.className)},toggleClass:function(e,n){return Array.isArray(e)?void e.forEach(function(e){t.toggleClass(e,n)}):void(e.classList?e.classList.toggle(n):t.hasClass(e,n)?t._removeClass(e,n):t._addClass(e,n))},$:function(e){return e="#"===e[0]?e.substr(1,e.length):e,document.getElementById(e)},isElement:function(e){return"HTMLElement"in window?!!e&&e instanceof HTMLElement:!!e&&"object"==typeof e&&1===e.nodeType&&!!e.nodeName},find:function(e,n,a){var s=/^(#?[\w-]+|\.[\w-.]+)$/,r=/\./g,i=Array.prototype.slice,o=[];if(n=n||window.document,s.test(e))switch(e[0]){case"#":o=[t.$(e.substr(1))];break;case".":o=i.call(n.getElementsByClassName(e.substr(1).replace(r," ")));break;default:o=i.call(n.getElementsByTagName(e))}else o=i.call(n.querySelectorAll(e));return a?o:o[0]},getAllChildren:function(e,t){return[].slice.call(e.getElementsByTagName(t))},emptyArray:function(e){for(;e.length;)e.pop()},removeAllChildren:function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},removeAll:function(e){for(var t;t=e[0];)t.parentNode.removeChild(t)},getChildren:function(e,t){return[].filter.call(e.childNodes,function(e){return t?1==e.nodeType&&e.tagName.toLowerCase()==t:1==e.nodeType})},template:function(e,t){var n=this;return e.replace(/\{ *([\w_-]+) *\}/g,function(e,a){var s=void 0===t[a]?"":t[a];return n.htmlEscape(s)})},htmlEscape:function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},mergeOptions:function(e,t){var n={};for(var a in e)n[a]=e[a];for(var s in t)n[s]=t[s];return n},escapeRegExp:function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},test:function(e,n){var a=new RegExp(t.escapeRegExp(e));return a.test(n)},createElement:function(e,t){var n;if(Array.isArray(e)){if(n=document.createElement(e[0]),e[1].id&&(n.id=e[1].id),e[1].classname&&(n.className=e[1].classname),e[1].attr){var a=e[1].attr;if(Array.isArray(a))for(var s=-1;++s<a.length;)n.setAttribute(a[s].name,a[s].value);else n.setAttribute(a.name,a.value)}}else n=document.createElement(e);n.innerHTML=t;for(var r=document.createDocumentFragment();n.childNodes[0];)r.appendChild(n.childNodes[0]);return n.appendChild(r),n},createFragment:function(e){var t=document.createDocumentFragment(),n=document.createElement("div");for(n.innerHTML=e;n.firstChild;)t.appendChild(n.firstChild);return t},clone:function(e){var n;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return n=new Date,n.setTime(e.getTime()),n;if(e instanceof Array){n=[];for(var a=0,s=e.length;s>a;a++)n[a]=t.clone(e[a]);return n}if(e instanceof Object){n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=t.clone(e[r]));return n}throw new Error("Unable to copy obj! Its type is not supported.")},isDefAndNotNull:function(e){return null!=e},assert:function(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}},assertEqual:function(e,t,n){if(e!=t)throw new Error(n+" mismatch: "+e+" != "+t)}},n=function(){var e={},t=e.hasOwnProperty;return{subscribe:function(n,a){t.call(e,n)||(e[n]=[]);var s=e[n].push(a)-1;return{remove:function(){delete e[n][s]}}},publish:function(n,a){t.call(e,n)&&e[n].forEach(function(e){e(void 0!==a?a:{})})}}}();return e.Base=function(n){var a={width:150,default_items:!0};e.options=t.mergeOptions(a,n),e.$base=this,e.$html=new e.Html,e.$internal=new e.Internal,ol.control.Control.call(this,{element:e.container})},ol.inherits(e.Base,ol.control.Control),e.Base.prototype.clear=function(){Object.keys(e.items).forEach(function(t){delete e.items[t]}),t.removeAllChildren(e.container)},e.Base.prototype.extend=function(e){t.assert(Array.isArray(e),"@param `arr` should be an Array."),e.forEach(this.push,this)},e.Base.prototype.push=function(n){t.assert(t.isDefAndNotNull(n),"@param `item` must be informed."),e.$html.addMenuEntry(n,e.$internal.getNextItemIndex()),e.$internal.positionContainer(e.$internal.getPixelClicked())},e.Base.prototype.pop=function(){var t=e.container.lastChild;t&&e.container.removeChild(t)},e.Base.prototype.getDefaultItems=function(){return e.defaultItems},e.Base.prototype.setMap=function(t){ol.control.Control.prototype.setMap.call(this,t),e.$internal.init(t)},e.Internal=function(){this.map=void 0,this.coordinate_clicked=void 0,this.pixel_clicked=void 0,this.counter=0,this.lineHeight=0,e.submenu={left:e.options.width-15+"px",last_left:""}},e.Internal.prototype={init:function(t){this.map=t,this.setListeners(),e.$html.createMenu(),this.lineHeight=e.container.offsetHeight/this.getItemsLength()},getItemsLength:function(){var t=0;return Object.keys(e.items).forEach(function(n){e.items[n].submenu||e.items[n].separator||t++}),t},getPixelClicked:function(){return this.pixel_clicked},getCoordinateClicked:function(){return this.coordinate_clicked},positionContainer:function(n){var a=e.Constants.css,s=this.map.getSize(),r=s[0],i=s[1],o=i-n[1],l=r-n[0],c={w:e.container.offsetWidth,h:Math.round(this.lineHeight*this.getItemsLength())},u=t.find("li."+a.submenu+">ul",e.container,!0);l>=c.w?(e.container.style.right="auto",e.container.style.left=n[0]+5+"px"):(e.container.style.left="auto",e.container.style.right="15px"),o>=c.h?(e.container.style.bottom="auto",e.container.style.top=n[1]-10+"px"):(e.container.style.top="auto",e.container.style.bottom="0px"),t.removeClass(e.container,a.hidden),u.length&&(l<2*c.w?e.submenu.last_left="-"+c.w+"px":e.submenu.last_left=e.submenu.left,u.forEach(function(t){t.style.left=e.submenu.last_left}))},openMenu:function(t,n){this.positionContainer(t),e.$base.dispatchEvent({type:e.EventType.OPEN,pixel:t,coordinate:n})},closeMenu:function(){t.addClass(e.container,e.Constants.css.hidden),e.$base.dispatchEvent({type:e.EventType.CLOSE})},getNextItemIndex:function(){return++this.counter},setListeners:function(){var t=this,a=this.map,s=a.getTargetElement(),r=function(e){e.stopPropagation(),e.preventDefault(),t.coordinate_clicked=a.getEventCoordinate(e),t.pixel_clicked=a.getEventPixel(e),t.openMenu(t.pixel_clicked,t.coordinate_clicked),s.addEventListener("mousedown",{handleEvent:function(e){t.closeMenu(),s.removeEventListener(e.type,this,!1)}},!1)};s.addEventListener("contextmenu",r,!1),n.subscribe(e.EventType.ADD_MENU_ENTRY,function(e){t.setItemListener(e.element,e.index)})},setItemListener:function(t,n){var a=this;t&&"function"==typeof e.items[n].callback&&!function(s){t.addEventListener("click",function(t){t.preventDefault();var r={coordinate:a.getCoordinateClicked(),data:e.items[n].data||null};a.closeMenu(),s.call(void 0,r,a.map)},!1)}(e.items[n].callback)}},e.EventType={OPEN:"open",CLOSE:"close",ADD_MENU_ENTRY:"add-menu-entry"},e.items={},e.Constants={css:{container:"ol-contextmenu ol-unselectable",separator:"ol-cm-separator",submenu:"ol-cm-submenu",hidden:"ol-cm-hidden",icon:"ol-cm-icon"}},e.defaultItems=[{text:"Zoom In",classname:"zoom-in "+e.Constants.css.icon,callback:function(e,t){var n=t.getView(),a=ol.animation.pan({duration:1e3,source:n.getCenter()}),s=ol.animation.zoom({duration:1e3,resolution:n.getResolution()});t.beforeRender(a,s),n.setCenter(e.coordinate),n.setZoom(+n.getZoom()+1)}},{text:"Zoom Out",classname:"zoom-out "+e.Constants.css.icon,callback:function(e,t){var n=t.getView(),a=ol.animation.pan({duration:1e3,source:n.getCenter()}),s=ol.animation.zoom({duration:1e3,resolution:n.getResolution()});t.beforeRender(a,s),n.setCenter(e.coordinate),n.setZoom(+n.getZoom()-1)}}],e.Html=function(){e.container=this.createContainer()},e.Html.prototype={createContainer:function(){var t=e.Constants.css,n=document.createElement("ul");return n.className=t.container+" "+t.hidden,n.style.width=parseInt(e.options.width,10)+"px",n},createMenu:function(){var t=e.options,n=[];return"items"in t?n=t.default_items?t.items.concat(e.defaultItems):t.items:t.default_items&&(n=e.defaultItems),0===n.length?!1:void n.forEach(this.addMenuEntry,this)},addMenuEntry:function(n){var a=e.Constants.css,s=this,r=e.$internal.getNextItemIndex();if(n.items&&Array.isArray(n.items)){n.classname=n.classname||"",t.test(a.submenu,n.classname)||(n.classname+=" "+a.submenu);var i=this.generateHtmlAndPublish(e.container,n,r),o=document.createElement("ul");o.className=a.container,o.style.left=e.submenu.last_left||e.submenu.left,o.style.width=e.options.width+"px",i.appendChild(o),n.items.forEach(function(t){s.generateHtmlAndPublish(o,t,e.$internal.getNextItemIndex(),!0)})}else this.generateHtmlAndPublish(e.container,n,r)},generateHtmlAndPublish:function(a,s,r,i){var o,l,c,u=!1,d=e.Constants.css;return"string"==typeof s&&"-"==s.trim()?(o='<li class="'+d.separator+'"><hr></li>',l=t.createFragment(o),c=[].slice.call(l.childNodes,0)[0],a.appendChild(l),u=!0):(s.classname=s.classname||"",o="<span>"+s.text+"</span>",l=t.createFragment(o),c=document.createElement("li"),s.icon&&(s.classname+=" "+d.icon,c.setAttribute("style","background-image:url("+s.icon+")")),c.id="index"+r,c.className=s.classname,c.appendChild(l),a.appendChild(c)),e.items[r]={id:r,submenu:i||0,separator:u,callback:s.callback,data:s.data||null},n.publish(e.EventType.ADD_MENU_ENTRY,{index:r,element:c}),c}},e.Base});
